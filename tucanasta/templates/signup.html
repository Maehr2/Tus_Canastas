{% load static %}
{% load widget_tweaks %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Crear cuenta - TuCanasta.cl</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons (eye icon) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

  <!-- Fuente -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">

  <style>
    body {
      background: linear-gradient(135deg, #007bff, #00bfa5);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      font-family: 'Poppins', sans-serif;
      margin: 0;
    }
    .register-card {
      background: #fff;
      border-radius: 18px;
      padding: 34px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.08);
      width: 100%;
      max-width: 680px;
      animation: fadeIn 0.9s ease-in-out;
    }
    @keyframes fadeIn { from { opacity:0; transform:translateY(12px);} to { opacity:1; transform:none; } }
    .form-label { font-weight: 600; }
    .help-muted { font-size: .9rem; color: #6b7280; }
    .pw-eye { cursor: pointer; user-select: none; }
    .small-note { font-size: .85rem; color: #6b7280; }
    .input-group .form-control.is-invalid + .input-group-text,
    .input-group .form-control.is-invalid ~ .input-group-text {
      border-color: #dc3545;
    }
    .checking { color:#6b7280; font-size:.9rem; }
    .exists-yes { color:#dc3545; font-weight:600; }
    .exists-no { color:#198754; font-weight:600; }
  </style>
</head>
<body>
  <div class="register-card">
    <h3 class="text-center mb-3 fw-bold" style="color:#0747a6;">Crear cuenta</h3>

    {% if messages %}
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">{{ message }}</div>
      {% endfor %}
    {% endif %}

    {% if form.non_field_errors %}
      <div class="alert alert-danger">
        {% for err in form.non_field_errors %}{{ err }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
      </div>
    {% endif %}

    <form method="post" id="signup-form" novalidate>
      {% csrf_token %}

      <!-- username -->
      <div class="mb-3">
        <label class="form-label">Nombre de usuario</label>
        {% if form.username.errors %}
          {{ form.username|add_class:"form-control is-invalid" }}
          <div class="invalid-feedback">
            {% for err in form.username.errors %}{{ err }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
          </div>
        {% else %}
          {{ form.username|add_class:"form-control" }}
        {% endif %}
      </div>

      <div class="row">
        <div class="col-md-6 mb-3">
          <label class="form-label">Nombre</label>
          {% if form.nombre.errors %}
            {{ form.nombre|add_class:"form-control is-invalid" }}
            <div class="invalid-feedback">
              {% for err in form.nombre.errors %}{{ err }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
            </div>
          {% else %}
            {{ form.nombre|add_class:"form-control" }}
          {% endif %}
        </div>

        <div class="col-md-6 mb-3">
          <label class="form-label">Apellido</label>
          {% if form.apellido.errors %}
            {{ form.apellido|add_class:"form-control is-invalid" }}
            <div class="invalid-feedback">
              {% for err in form.apellido.errors %}{{ err }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
            </div>
          {% else %}
            {{ form.apellido|add_class:"form-control" }}
          {% endif %}
        </div>
      </div>

      <div class="mb-3">
        <label class="form-label">RUT</label>
        {% if form.rut.errors %}
          {{ form.rut|add_class:"form-control is-invalid" }}
          <div class="invalid-feedback">
            {% for err in form.rut.errors %}{{ err }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
          </div>
        {% else %}
          {{ form.rut|add_class:"form-control" }}
          <div class="form-text small-note">Formato: 12.345.678-K o 12345678-K — se valida automáticamente.</div>
        {% endif %}
      </div>

      <div class="mb-3">
        <label class="form-label">Dirección</label>
        {% if form.direccion.errors %}
          {{ form.direccion|add_class:"form-control is-invalid" }}
          <div class="invalid-feedback">
            {% for err in form.direccion.errors %}{{ err }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
          </div>
        {% else %}
          {{ form.direccion|add_class:"form-control" }}
        {% endif %}
      </div>

      <div class="mb-3">
        <label class="form-label">Correo electrónico</label>
        <div class="d-flex gap-2 align-items-center">
          <div style="flex:1">
            {% if form.email.errors %}
              {{ form.email|add_class:"form-control is-invalid" }}
              <div class="invalid-feedback">
                {% for err in form.email.errors %}{{ err }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
              </div>
            {% else %}
              {{ form.email|add_class:"form-control" }}
            {% endif %}
          </div>
          <div id="email-check-status" class="checking small-note ms-2" aria-live="polite"></div>
        </div>
      </div>

      <div class="row">
        <div class="col-md-6 mb-3">
          <label class="form-label">Contraseña</label>
          <div class="input-group">
            {% if form.password1.errors %}
              {{ form.password1|add_class:"form-control is-invalid" }}
            {% else %}
              {{ form.password1|add_class:"form-control" }}
            {% endif %}
            <span class="input-group-text pw-eye" data-target="password1"><i class="bi bi-eye-slash"></i></span>
            {% if form.password1.errors %}
              <div class="invalid-feedback d-block">
                {% for err in form.password1.errors %}{{ err }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
              </div>
            {% endif %}
          </div>
          <div class="form-text small-note">Mínimo 8 caracteres y no contener información personal.</div>
        </div>

        <div class="col-md-6 mb-3">
          <label class="form-label">Confirmar contraseña</label>
          <div class="input-group">
            {% if form.password2.errors %}
              {{ form.password2|add_class:"form-control is-invalid" }}
            {% else %}
              {{ form.password2|add_class:"form-control" }}
            {% endif %}
            <span class="input-group-text pw-eye" data-target="password2"><i class="bi bi-eye-slash"></i></span>
            {% if form.password2.errors %}
              <div class="invalid-feedback d-block">
                {% for err in form.password2.errors %}{{ err }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
              </div>
            {% endif %}
          </div>
        </div>
      </div>

      <div class="d-grid mt-2">
        <button type="submit" class="btn btn-primary py-2">Registrarme</button>
      </div>
    </form>

    <p class="text-center mt-3">¿Ya tienes cuenta? <a href="{% url 'login' %}" class="text-decoration-none">Iniciar sesión</a></p>
    <p class="text-center"><a href="{% url 'index' %}" class="text-muted small">← Volver al inicio</a></p>
  </div>

  <!-- Bootstrap JS + Icons -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
  (function(){
    const form = document.getElementById('signup-form');
    if (!form) return;

    const get = (name) => form.elements[name];
    const username = get('username');
    const rut = get('rut');
    const email = get('email');
    const pw1 = get('password1');
    const pw2 = get('password2');
    const emailStatus = document.getElementById('email-check-status');

    function showError(input, msg) {
      if (!input) return;
      input.classList.add('is-invalid');
      let parent = input.closest('.input-group') || input.parentElement;
      let fb = parent.querySelector('.invalid-feedback.client-side');
      if (!fb) {
        fb = document.createElement('div');
        fb.className = 'invalid-feedback client-side';
        parent.appendChild(fb);
      }
      fb.innerText = msg;
    }
    function clearError(input) {
      if (!input) return;
      input.classList.remove('is-invalid');
      let parent = input.closest('.input-group') || input.parentElement;
      let fb = parent.querySelector('.invalid-feedback.client-side');
      if (fb) fb.remove();
    }

    // --------------------------
    // RUT validation (mod 11)
    // --------------------------
    function normalizeRut(raw) {
      if (!raw) return '';
      return raw.replace(/\./g,'').replace(/\s+/g,'').toUpperCase();
    }
    function rutDVFromNumber(numStr) {
      // numStr should be only digits, reversed algorithm
      let sum = 0;
      let mul = 2;
      for (let i = numStr.length - 1; i >= 0; i--) {
        sum += parseInt(numStr[i], 10) * mul;
        mul = (mul === 7) ? 2 : mul + 1;
      }
      const mod = 11 - (sum % 11);
      if (mod === 11) return '0';
      if (mod === 10) return 'K';
      return String(mod);
    }
    function validateRutFull(raw) {
  const v = normalizeRut(raw);
  if (!v) return { ok:false, msg:'RUT requerido' };
  const parts = v.split('-');
  if (parts.length !== 2) return { ok:false, msg:'Formato RUT inválido (falta guion)' };
  const num = parts[0].replace(/^0+/, '') || '0';
  const dv = parts[1].toUpperCase();
  if (!/^\d{7,8}$/.test(num)) return { ok:false, msg:'Nº RUT inválido' };
  const expected = rutDVFromNumber(num);
  if (expected !== dv) return { ok:false, msg:'Dígito verificador incorrecto, por favor verifica tu RUT.' };
  return { ok:true };
}


    // --------------------------
    // Email format & optional existence check
    // --------------------------
    function validEmail(v) {
      if (!v) return false;
      const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return re.test(v);
    }

    async function checkEmailExistsRemote(emailValue) {
      // Este bloque intenta llamar a un endpoint opcional que puedas crear:
      // /api/check-email/?email=...
      // Si no existe (404) no rompe: devolvemos null (indeterminado) y el server validará al submit.
      try {
        const url = `/api/check-email/?email=${encodeURIComponent(emailValue)}`;
        const resp = await fetch(url, { method:'GET', headers: { 'Accept':'application/json' } });
        if (resp.status === 404) return null; // endpoint no disponible -> fallback
        if (!resp.ok) return null;
        const j = await resp.json();
        // esperar { exists: true/false }
        if (typeof j.exists === 'boolean') return j.exists;
        return null;
      } catch(e) {
        // network / CORS -> fallback
        return null;
      }
    }

    // --------------------------
    // Password checks (client-side)
    // --------------------------
    function passwordChecks(pw, context) {
      if (!pw) return 'La contraseña es requerida.';
      if (pw.length < 8) return 'La contraseña debe tener al menos 8 caracteres.';
      if (/^\d+$/.test(pw)) return 'La contraseña no puede ser sólo números.';
      if (context) {
        const nameLower = (context.username||'').toLowerCase();
        const emailLocal = (context.emailLocal||'').toLowerCase();
        const pwLower = pw.toLowerCase();
        if (nameLower && nameLower.length >= 3 && pwLower.includes(nameLower)) return 'La contraseña no puede contener el nombre de usuario.';
        if (emailLocal && emailLocal.length >= 3 && pwLower.includes(emailLocal)) return 'La contraseña no puede contener la parte local del email.';
      }
      return null;
    }

    // clear errors on input
    [username, rut, email, pw1, pw2].forEach(el => {
      if (!el) return;
      el.addEventListener('input', () => {
        clearError(el);
        if (emailStatus) { emailStatus.textContent = ''; emailStatus.className = 'checking small-note ms-2'; }
      });
    });

    // email blur -> format check + optional remote check
    email?.addEventListener('blur', async () => {
      const v = (email.value||'').trim();
      if (!v) return;
      if (!validEmail(v)) {
        showError(email, 'Formato de correo inválido.');
        return;
      }
      // try remote check (graceful fallback)
      if (emailStatus) {
        emailStatus.textContent = 'Comprobando disponibilidade...';
      }
      const exists = await checkEmailExistsRemote(v);
      if (exists === true) {
        if (emailStatus) { emailStatus.textContent = 'Correo ya registrado'; emailStatus.className = 'exists-yes ms-2'; }
        showError(email, 'Este correo ya está en uso.');
      } else if (exists === false) {
        if (emailStatus) { emailStatus.textContent = 'Correo disponible'; emailStatus.className = 'exists-no ms-2'; }
        clearError(email);
      } else {
        if (emailStatus) { emailStatus.textContent = ''; emailStatus.className = 'checking small-note ms-2'; }
        // fallback: no endpoint -> server-side will enforce uniqueness on submit
      }
    });

    // eye toggles
    document.querySelectorAll('.pw-eye').forEach(btn => {
      btn.addEventListener('click', () => {
        const targetName = btn.getAttribute('data-target');
        let input = get(targetName);
        if (!input) input = btn.previousElementSibling && btn.previousElementSibling.tagName === 'INPUT' ? btn.previousElementSibling : null;
        if (!input) return;
        if (input.type === 'password') {
          input.type = 'text';
          btn.querySelector('i')?.classList.replace('bi-eye-slash','bi-eye');
        } else {
          input.type = 'password';
          btn.querySelector('i')?.classList.replace('bi-eye','bi-eye-slash');
        }
      });
    });

    // main submit validation
    form.addEventListener('submit', function(evt){
      let invalid = false;

      // RUT
      if (rut) {
        const res = validateRutFull(rut.value);
        if (!res.ok) {
          showError(rut, res.msg);
          invalid = true;
        } else {
          clearError(rut);
        }
      }

      // Email format
      if (email) {
        const v = (email.value||'').trim();
        if (!v) {
          showError(email, 'Correo requerido.');
          invalid = true;
        } else if (!validEmail(v)) {
          showError(email, 'Correo inválido.');
          invalid = true;
        } else {
          // we tried to check remote on blur; even if we didn't, server will validate uniqueness
          clearError(email);
        }
      }

      // Passwords
      const ctx = {
        username: username ? username.value : '',
        emailLocal: email ? ((email.value||'').split('@')[0]) : ''
      };
      if (pw1) {
        const pwErr = passwordChecks(pw1.value, ctx);
        if (pwErr) {
          showError(pw1, pwErr);
          invalid = true;
        } else {
          clearError(pw1);
        }
      }
      if (pw1 && pw2) {
        if (pw1.value !== pw2.value) {
          showError(pw2, 'Las contraseñas no coinciden.');
          invalid = true;
        } else {
          clearError(pw2);
        }
      }

      if (invalid) {
        evt.preventDefault();
        evt.stopPropagation();
        const firstInvalid = form.querySelector('.is-invalid');
        if (firstInvalid) { firstInvalid.scrollIntoView({behavior:'smooth', block:'center'}); firstInvalid.focus({preventScroll:true}); }
      }
    });

  })();
  </script>
</body>
</html>
