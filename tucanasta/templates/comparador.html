{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tucanasta ‚Äî Comparador</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Tus estilos -->
  <link rel="stylesheet" href="{% static 'css/main.css' %}">
</head>
<body class="bg-light">

  <!-- NAVBAR -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top shadow-sm">
    <div class="container-fluid">
      <!-- Offcanvas toggler -->
      <button class="btn btn-outline-light me-3" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasCategorias" aria-controls="offcanvasCategorias">
        ‚ò∞
      </button>

      <a class="navbar-brand d-flex align-items-center" href="{% url 'comparador' %}">
        <img src="{% static 'img/logotucan.png' %}" alt="Tucanasta" class="logo-img me-2">
        <span class="brand-text">Tucanasta</span>
      </a>

      <!-- Search (desktop) -->
      <form class="d-none d-lg-flex ms-auto me-3" method="get" action="{% url 'comparador' %}">
        <div class="input-group">
          <input class="form-control" name="q" value="{{ query }}" placeholder="Buscar productos..." aria-label="Buscar">
          <button class="btn btn-success" type="submit">üîç</button>
        </div>
      </form>

      <!-- User + Mini-cart -->
      <div class="ms-2 d-flex align-items-center gap-2">

        <!-- Mini-cart toggle -->
        <button class="btn btn-outline-light position-relative" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasCart" aria-controls="offcanvasCart" id="cart-toggle">
          üß∫
          <span id="cot-badge" class="badge bg-danger ms-1">
            {% if cot_items %}{{ cot_items|length }}{% else %}0{% endif %}
          </span>
        </button>

        <!-- User -->
        {% if user.is_authenticated %}
          <div class="dropdown">
            <button class="btn btn-outline-light dropdown-toggle" type="button" id="userMenu" data-bs-toggle="dropdown" aria-expanded="false">
              üë§ {{ user.username }}
            </button>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userMenu">
              <li><a class="dropdown-item" href="{% url 'ver_cotizacion' %}">Cotizaciones</a></li>
              <li><a class="dropdown-item" href="{% url 'ajustes' %}">Ajustes</a></li>
              <li><hr class="dropdown-divider"></li>
              <li>
                <form method="post" action="{% url 'logout' %}" class="m-0">
                  {% csrf_token %}
                  <button type="submit" class="dropdown-item">Cerrar sesi√≥n</button>
                </form>
              </li>
            </ul>
          </div>
        {% else %}
          <a href="{% url 'login' %}" class="btn btn-outline-light">Iniciar sesi√≥n</a>
        {% endif %}
      </div>

    </div>
  </nav>

  <!-- OFFCANVAS: CATEGOR√çAS -->
  <div class="offcanvas offcanvas-start text-bg-dark" tabindex="-1" id="offcanvasCategorias" aria-labelledby="offcanvasCategoriasLabel">
    <div class="offcanvas-header">
      <h5 id="offcanvasCategoriasLabel">Categor√≠as</h5>
      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Cerrar"></button>
    </div>
    <div class="offcanvas-body">
      <div class="list-group list-group-flush">
        <a href="{% url 'comparador' %}" class="list-group-item list-group-item-action bg-dark text-light">Todas</a>
        {% for tipo in tipos %}
          <a href="{% url 'productos_por_categoria' tipo=tipo %}" class="list-group-item list-group-item-action bg-dark text-light {% if tipo == tipo_seleccionado %}active{% endif %}">
            {{ tipo }}
          </a>
        {% empty %}
          <div class="px-3 py-2 text-muted">Sin categor√≠as</div>
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- OFFCANVAS: MINI-CART (COTIZACI√ìN) -->
  <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasCart" aria-labelledby="offcanvasCartLabel">
    <div class="offcanvas-header">
      <h5 id="offcanvasCartLabel">Mi cotizaci√≥n</h5>
      <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Cerrar"></button>
    </div>

    <div class="offcanvas-body d-flex flex-column">
      <div id="cart-items-list" class="list-group mb-3">
        {% if cot_items %}
          {% for it in cot_items %}
            <div class="list-group-item d-flex align-items-center gap-3" data-item-id="{{ it.pk }}">
              <img src="{{ it.producto.imagen_url|default:'/static/img/placeholder.png' }}" alt="" style="width:56px;height:56px;object-fit:contain;border-radius:6px;border:1px solid #eee">
              <div class="flex-grow-1">
                <div class="fw-semibold">{{ it.producto.nombre|truncatechars:50 }}</div>
                <div class="small text-muted">{{ it.producto.supermercado.nombre }} ¬∑ ${{ it.precio_unidad|floatformat:0 }}</div>
                <div class="mt-1 d-flex align-items-center gap-2">
                  <button class="btn btn-sm btn-outline-secondary dec-item">‚àí</button>
                  <input type="number" class="form-control form-control-sm qty-in-cart" value="{{ it.cantidad }}" min="1" style="width:72px;">
                  <button class="btn btn-sm btn-outline-secondary inc-item">+</button>
                </div>
              </div>
              <div class="text-end">
                <div class="fw-bold subtotal-in-cart">${{ it.subtotal|floatformat:0 }}</div>
                <button class="btn btn-sm btn-link text-danger remove-item-in-cart">Eliminar</button>
              </div>
            </div>
          {% endfor %}
        {% else %}
          <div class="text-center text-muted py-4" id="cart-empty">No hay productos en la cotizaci√≥n.</div>
        {% endif %}
      </div>

      <div class="mt-auto">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="text-muted">Total estimado</div>
          <div class="fs-5 fw-bold text-success" id="cart-total">${% if cotizacion %}{{ cotizacion.total|floatformat:0 }}{% else %}0{% endif %}</div>
        </div>
        <div class="d-grid gap-2">
          <a href="{% url 'ver_cotizacion' %}" class="btn btn-primary">Ver cotizaci√≥n completa</a>
          <button id="save-cart-btn" class="btn btn-outline-success">Guardar cotizaci√≥n</button>
        </div>
      </div>
    </div>
  </div>

  <!-- MAIN -->
  <main class="container-fluid mt-5 pt-4">
    <!-- mobile search -->
    <div class="row d-lg-none mb-3 px-3">
      <div class="col-12">
        <form method="get" action="{% url 'comparador' %}" class="input-group">
          <input class="form-control" name="q" value="{{ query }}" placeholder="Buscar productos...">
          <button class="btn btn-success" type="submit">üîç</button>
        </form>
      </div>
    </div>

    {% for grupo in data_supermercados %}
      <section class="mb-5">
        <div class="d-flex align-items-center justify-content-between px-3 mb-2">
          <h5 class="mb-0 supermercado-title">{{ grupo.supermercado.nombre }}</h5>
          <a href="{% url 'productos_por_categoria' tipo=grupo.supermercado.nombre %}" class="small text-decoration-none">Ver todo ‚Üí</a>
        </div>

        {% if grupo.productos %}
          <div class="position-relative px-3">
            <button class="carousel-arrow left-arrow d-none d-md-inline-flex" aria-label="Anterior" data-target="#track-{{ forloop.counter }}" data-dir="-1">‚óÄ</button>

            <div id="track-{{ forloop.counter }}" class="productos-track d-flex gap-3 overflow-auto py-2">
              {% for p in grupo.productos %}
                <div class="card product-card" tabindex="0" style="min-width:210px; max-width:220px;">
                  <a class="d-block text-center p-2" href="{{ p.producto_url }}" target="_blank" rel="noopener">
                    <img src="{{ p.imagen_url|default:'/static/img/placeholder.png' }}" alt="{{ p.nombre }}" class="product-img mx-auto" style="height:140px; width:auto;">
                  </a>
                  <div class="card-body p-2 d-flex flex-column" style="min-height:135px;">
                    <h6 class="card-title mb-1 product-name">{{ p.nombre|truncatechars:60 }}</h6>
                    <p class="text-muted small mb-2">{{ p.marca }}</p>
                    <div class="mt-auto d-flex justify-content-between align-items-center">
                      <div class="price text-success fw-bold">${{ p.precio|floatformat:0 }}</div>
                      <button class="btn btn-sm btn-success add-btn" data-product-id="{{ p.id }}">Agregar</button>
                    </div>
                  </div>
                </div>
              {% endfor %}
            </div>

            <button class="carousel-arrow right-arrow d-none d-md-inline-flex" aria-label="Siguiente" data-target="#track-{{ forloop.counter }}" data-dir="1">‚ñ∂</button>
          </div>
        {% else %}
          <p class="px-3 text-muted">No hay productos disponibles en {{ grupo.supermercado.nombre }}.</p>
        {% endif %}
      </section>
    {% empty %}
      <p class="px-3 text-muted">No hay productos disponibles.</p>
    {% endfor %}
  </main>

  <footer class="text-center text-muted py-4 mt-4 bg-white">
    ¬© 2025 Tucanasta. Todos los derechos reservados.
  </footer>

  <!-- Bootstrap JS bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Tiny JS: arrastre + flechas + offcanvas close on click + mini-cart -->
<script>
/* ---------- util: CSRF ---------- */
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
const csrftoken = getCookie('csrftoken');

/* ---------- Flechas: scroll del track ---------- */
document.querySelectorAll('.carousel-arrow').forEach(btn => {
  btn.addEventListener('click', () => {
    const target = document.querySelector(btn.dataset.target);
    if (!target) return;
    const card = target.querySelector('.product-card');
    const gap = parseInt(getComputedStyle(target).gap) || 16;
    const step = (card ? card.offsetWidth : 220) + gap;
    const dir = parseInt(btn.dataset.dir, 10) || 1;
    target.scrollBy({ left: dir * step * 2, behavior: 'smooth' }); // mueve 2 tarjetas
  });
});

/* ---------- Drag-to-scroll (mouse + touch) ---------- */
document.querySelectorAll('.productos-track').forEach(track => {
  let isDown = false, startX = 0, scrollLeft = 0;
  track.addEventListener('mousedown', (e) => {
    isDown = true;
    track.classList.add('dragging');
    startX = e.pageX - track.offsetLeft;
    scrollLeft = track.scrollLeft;
  });
  track.addEventListener('mouseleave', () => { isDown = false; track.classList.remove('dragging'); });
  track.addEventListener('mouseup', () => { isDown = false; track.classList.remove('dragging'); });
  track.addEventListener('mousemove', (e) => {
    if (!isDown) return;
    e.preventDefault();
    const x = e.pageX - track.offsetLeft;
    const walk = (x - startX) * 1.5;
    track.scrollLeft = scrollLeft - walk;
  });

  // touch
  let touchStartX = 0;
  track.addEventListener('touchstart', e => { touchStartX = e.touches[0].clientX; });
  track.addEventListener('touchmove', e => {
    const touchX = e.touches[0].clientX;
    const diff = touchStartX - touchX;
    track.scrollLeft += diff;
    touchStartX = touchX;
  });
});

/* ---------- Close offcanvas when clicking a category (UX mobile) ---------- */
document.querySelectorAll('#offcanvasCategorias .list-group-item').forEach(link => {
  link.addEventListener('click', () => {
    const off = bootstrap.Offcanvas.getInstance(document.getElementById('offcanvasCategorias'));
    if (off) off.hide();
  });
});

/* =========================
   MINI-CART / AJAX HANDLERS
   ========================= */

/* helpers DOM */
const badgeEl = document.getElementById('cot-badge');
const cartList = document.getElementById('cart-items-list');
const cartTotalEl = document.getElementById('cart-total');
const cartEmpty = document.getElementById('cart-empty');

function formatMoney(n){ return '$' + (parseFloat(n || 0).toFixed(0)); }

function postForm(url, data){
  return fetch(url, {
    method: 'POST',
    headers: {
      'X-CSRFToken': csrftoken,
      'X-Requested-With': 'XMLHttpRequest',
      'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'
    },
    body: new URLSearchParams(data)
  }).then(r => r.json());
}

/* Actualiza o agrega un item en el mini-cart (DOM) usando la respuesta del servidor */
function addOrUpdateCartItemFromResponse(data){
  // data: { ok, item_id, producto, cantidad, subtotal, total }
  if (!data || !data.ok) return;
  const id = String(data.item_id);
  let row = cartList.querySelector(`[data-item-id="${id}"]`);
  if (row){
    const qty = row.querySelector('.qty-in-cart');
    const subtotal = row.querySelector('.subtotal-in-cart');
    if (qty) qty.value = data.cantidad;
    if (subtotal) subtotal.innerText = formatMoney(data.subtotal);
  } else {
    const div = document.createElement('div');
    div.className = 'list-group-item d-flex align-items-center gap-3';
    div.dataset.itemId = id;
    div.innerHTML = `
      <img src="${data.producto_imagen || '/static/img/placeholder.png'}" alt="" style="width:56px;height:56px;object-fit:contain;border-radius:6px;border:1px solid #eee">
      <div class="flex-grow-1">
        <div class="fw-semibold">${data.producto}</div>
        <div class="small text-muted">${data.supermercado || ''} ¬∑ ${formatMoney(data.precio_unidad)}</div>
        <div class="mt-1 d-flex align-items-center gap-2">
          <button class="btn btn-sm btn-outline-secondary dec-item">‚àí</button>
          <input type="number" class="form-control form-control-sm qty-in-cart" value="${data.cantidad}" min="1" style="width:72px;">
          <button class="btn btn-sm btn-outline-secondary inc-item">+</button>
        </div>
      </div>
      <div class="text-end">
        <div class="fw-bold subtotal-in-cart">${formatMoney(data.subtotal)}</div>
        <button class="btn btn-sm btn-link text-danger remove-item-in-cart">Eliminar</button>
      </div>`;
    cartList.prepend(div);
    if (cartEmpty) cartEmpty.style.display = 'none';
  }

  // badge y total
  if (badgeEl){
    // si servidor retorna count, usarlo; si no, incrementar
    if (data.count !== undefined) badgeEl.innerText = String(data.count);
    else {
      const current = parseInt(badgeEl.innerText.replace(/\D/g,'')) || 0;
      badgeEl.innerText = current + 1;
    }
  }
  if (cartTotalEl && data.total !== undefined) cartTotalEl.innerText = formatMoney(data.total);
}

/* Delegado: clicks en mini-cart (inc/dec/remove) */
cartList?.addEventListener('click', async (ev) => {
  const target = ev.target;
  const row = target.closest('[data-item-id]');
  if (!row) return;
  const itemId = row.dataset.itemId;

  if (target.classList.contains('inc-item')){
    const input = row.querySelector('.qty-in-cart');
    const nueva = Math.max(1, parseInt(input.value || 0) + 1);
    await updateQty(itemId, nueva, row);
  } else if (target.classList.contains('dec-item')){
    const input = row.querySelector('.qty-in-cart');
    const nueva = Math.max(1, parseInt(input.value || 0) - 1);
    await updateQty(itemId, nueva, row);
  } else if (target.classList.contains('remove-item-in-cart')){
    if (!confirm('¬øEliminar este item de la cotizaci√≥n?')) return;
    await eliminarItem(itemId, row);
  }
});

/* change handler on qty-in-cart */
cartList?.addEventListener('change', async (ev) => {
  const input = ev.target;
  if (input.classList.contains('qty-in-cart')){
    const row = input.closest('[data-item-id]');
    const itemId = row.dataset.itemId;
    const nueva = Math.max(1, parseInt(input.value || 1));
    await updateQty(itemId, nueva, row);
  }
});

async function updateQty(itemId, cantidad, row){
  try {
    const res = await postForm("{% url 'actualizar_item' %}", { item_id: itemId, cantidad });
    if (res.ok){
      if (res.total !== undefined) cartTotalEl.innerText = formatMoney(res.total);
      const qty = row.querySelector('.qty-in-cart');
      if (qty) qty.value = cantidad;
      if (res.subtotal !== undefined){
        const subtotalEl = row.querySelector('.subtotal-in-cart');
        if (subtotalEl) subtotalEl.innerText = formatMoney(res.subtotal);
      }
    } else {
      alert(res.error || 'No se pudo actualizar la cantidad');
    }
  } catch (e){
    console.error(e);
    alert('Error red al actualizar cantidad');
  }
}

async function eliminarItem(itemId, row){
  try {
    const res = await postForm("{% url 'eliminar_item' %}", { item_id: itemId });
    if (res.ok){
      row.remove();
      if (res.total !== undefined) cartTotalEl.innerText = formatMoney(res.total);
      if (badgeEl){
        if (res.count !== undefined) badgeEl.innerText = String(res.count);
        else {
          const curr = parseInt(badgeEl.innerText.replace(/\D/g,'')) || 1;
          badgeEl.innerText = Math.max(0, curr - 1);
        }
      }
      if (!cartList.querySelector('[data-item-id]') && cartEmpty) cartEmpty.style.display = 'block';
    } else {
      alert(res.error || 'No se pudo eliminar el item');
    }
  } catch (e){
    console.error(e);
    alert('Error red al eliminar item');
  }
}

/* Guardar cotizaci√≥n */
document.getElementById('save-cart-btn')?.addEventListener('click', async ()=> {
  try {
    const res = await postForm("{% url 'guardar_cotizacion' %}", {});
    if (res.ok){
      window.location.href = "{% url 'mis_cotizaciones' %}";
    } else {
      alert(res.error || 'No se pudo guardar la cotizaci√≥n');
    }
  } catch (e){
    console.error(e);
    alert('Error red al guardar la cotizaci√≥n');
  }
});

/* ---------- Handler "Agregar" para cada tarjeta ---------- */
document.querySelectorAll('.add-btn').forEach(b => {
  let inFlight = false;
  b.addEventListener('click', async (e) => {
    if (inFlight) return;
    inFlight = true;

    const id = b.dataset.productId;
    if (!id) { inFlight = false; return; }

    const prevText = b.innerText;
    b.classList.add('disabled');
    b.innerText = 'Enviando...';

    try {
      const resFetch = await fetch("{% url 'agregar_cotizacion' %}", {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrftoken,
          'X-Requested-With': 'XMLHttpRequest',
          'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'
        },
        body: new URLSearchParams({ product_id: id, cantidad: 1 })
      });

      if (resFetch.redirected) {
        window.location.href = resFetch.url;
        return;
      }

      const ct = resFetch.headers.get('content-type') || '';
      if (ct.includes('application/json')) {
        const data = await resFetch.json();
        if (data.ok){
          b.innerText = 'Agregado';
          // actualiza DOM del mini-cart
          addOrUpdateCartItemFromResponse(data);
        } else {
          alert(data.error || 'No se pudo agregar');
          b.innerText = prevText;
        }
      } else {
        const text = await resFetch.text();
        console.error('Respuesta unexpected:', text);
        alert('Respuesta inesperada del servidor (ver consola).');
        b.innerText = prevText;
      }
    } catch (err) {
      console.error('Error al agregar:', err);
      alert('Error de red al agregar producto.');
      b.innerText = prevText;
    } finally {
      setTimeout(()=>{ b.classList.remove('disabled'); inFlight = false; }, 700);
    }
  });
});
</script>
</body>
</html>
