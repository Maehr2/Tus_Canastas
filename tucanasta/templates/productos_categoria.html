{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>{{ tipo }} - Tucanasta üõí</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'css/categoria.css' %}">
  <meta name="viewport" content="width=device-width,initial-scale=1">
</head>

<body>

  <!-- NAVBAR -->
  <header class="navbar navbar-dark px-3 d-flex align-items-center" style="height:70px;">
    <a href="{% url 'comparador' %}" class="d-flex align-items-center text-decoration-none me-3">
      <img src="{% static 'img/logotucan.png' %}" alt="Tucanasta" class="logo-img me-2" style="height:40px;">
      <span class="brand-name">Tucanasta</span>
    </a>

    <form method="get" action="" class="search-bar ms-3 me-auto d-flex" style="gap:8px;">
      <input type="text" name="q" placeholder="Buscar en {{ tipo }}..." value="{{ request.GET.q }}" class="form-control">
      <button type="submit" class="btn btn-success">üîç</button>
    </form>

    <div class="ms-3 d-flex align-items-center gap-2">
      <!-- Mini-cart toggle -->
      <button class="btn btn-outline-light position-relative" type="button"
              data-bs-toggle="offcanvas" data-bs-target="#offcanvasCart" aria-controls="offcanvasCart" id="cart-toggle">
        üß∫
        <span id="cot-badge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
          {% if cot_items %}{{ cot_items|length }}{% else %}0{% endif %}
        </span>
      </button>

      {% if user.is_authenticated %}
        <a href="{% url 'ver_cotizacion' %}" class="btn btn-outline-light">Mis cotizaciones</a>
      {% else %}
        <a href="{% url 'login' %}" class="btn btn-outline-light">Iniciar sesi√≥n</a>
      {% endif %}
    </div>
  </header>

  <!-- OFFCANVAS: MINI-CART -->
  <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasCart" aria-labelledby="offcanvasCartLabel">
    <div class="offcanvas-header">
      <h5 id="offcanvasCartLabel">Mi cotizaci√≥n</h5>
      <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Cerrar"></button>
    </div>

    <div class="offcanvas-body d-flex flex-column">
      <div id="cart-items-list" class="list-group mb-3">
        {% if cot_items %}
          {% for it in cot_items %}
            <div class="list-group-item d-flex align-items-center gap-3" data-item-id="{{ it.pk }}">
              <img src="{{ it.producto.imagen_url|default:'/static/img/placeholder.png' }}" alt=""
                   style="width:56px;height:56px;object-fit:contain;border-radius:6px;border:1px solid #eee">
              <div class="flex-grow-1">
                <div class="fw-semibold">{{ it.producto.nombre|truncatechars:50 }}</div>
                <div class="small text-muted">{{ it.producto.supermercado.nombre }} ¬∑ ${{ it.precio_unidad|floatformat:0 }}</div>
                <div class="mt-1 d-flex align-items-center gap-2">
                  <button class="btn btn-sm btn-outline-secondary dec-item">‚àí</button>
                  <input type="number" class="form-control form-control-sm qty-in-cart" value="{{ it.cantidad }}" min="1" style="width:72px;">
                  <button class="btn btn-sm btn-outline-secondary inc-item">+</button>
                </div>
              </div>
              <div class="text-end">
                <div class="fw-bold subtotal-in-cart">${{ it.subtotal|floatformat:0 }}</div>
                <button class="btn btn-sm btn-link text-danger remove-item-in-cart">Eliminar</button>
              </div>
            </div>
          {% endfor %}
        {% else %}
          <div class="text-center text-muted py-4" id="cart-empty">No hay productos en la cotizaci√≥n.</div>
        {% endif %}
      </div>

      <div class="mt-auto">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="text-muted">Total estimado</div>
          <div class="fs-5 fw-bold text-success" id="cart-total">${% if cotizacion %}{{ cotizacion.total|floatformat:0 }}{% else %}0{% endif %}</div>
        </div>
        <div class="d-grid gap-2">
          <a href="{% url 'ver_cotizacion' %}" class="btn btn-primary">Ver cotizaci√≥n completa</a>
          <button id="save-cart-btn" class="btn btn-outline-success">Guardar cotizaci√≥n</button>
        </div>
      </div>
    </div>
  </div>

  <!-- MAIN -->
  <main class="container-fluid" style="padding-top: 90px;">
    <div class="row">
      <!-- SIDEBAR filtros -->
      <aside class="col-lg-3 mb-4">
        <form id="filters-form" method="get">
          <h4>Filtros</h4>
          <div class="mb-3">
            <label class="form-label">Ordenar por</label>
            <select name="ordenar" class="form-select" onchange="this.form.submit()">
              <option value="">Relevancia</option>
              <option value="precio_asc" {% if ordenar == 'precio_asc' %}selected{% endif %}>Precio: Menor a mayor</option>
              <option value="precio_desc" {% if ordenar == 'precio_desc' %}selected{% endif %}>Precio: Mayor a menor</option>
              <option value="nombre_asc" {% if ordenar == 'nombre_asc' %}selected{% endif %}>Nombre: A-Z</option>
            </select>
          </div>

          <div class="mb-3">
            <h5>Marcas</h5>
            <ul class="list-unstyled">
              {% for marca in marcas %}
                <li>
                  <label class="form-check-label">
                    <input type="checkbox" name="marca" value="{{ marca }}" class="form-check-input me-1"
                           {% if marca in marca_filtro %}checked{% endif %} onchange="this.form.submit()">
                    {{ marca }}
                  </label>
                </li>
              {% empty %}
                <li class="text-muted">No hay marcas registradas.</li>
              {% endfor %}
            </ul>
          </div>

          <div class="mb-3">
            <h5>Tiendas</h5>
            <ul class="list-unstyled">
              {% for tienda in tiendas %}
                <li>
                  <label class="form-check-label">
                    <input type="checkbox" name="tienda" value="{{ tienda }}" class="form-check-input me-1"
                           {% if tienda in tienda_filtro %}checked{% endif %} onchange="this.form.submit()">
                    {{ tienda }}
                  </label>
                </li>
              {% empty %}
                <li class="text-muted">No hay tiendas disponibles.</li>
              {% endfor %}
            </ul>
          </div>

          {% if request.GET.q %}
            <input type="hidden" name="q" value="{{ request.GET.q }}">
          {% endif %}

          <button type="button" class="btn btn-secondary w-100" onclick="window.location.href=window.location.pathname">Limpiar filtros ‚úñ</button>
        </form>
      </aside>

      <!-- productos -->
      <section class="col-lg-9">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div>
            <h2 class="mb-0">{{ tipo|capfirst }} disponibles</h2>
            <small class="text-muted">{{ productos|length }} resultados</small>
          </div>
        </div>

        <div class="row g-3">
          {% for p in productos %}
            <div class="col-6 col-md-4 col-lg-3">
              <div class="card h-100 product-card">
                <a href="{{ p.producto_url }}" target="_blank" rel="noopener" class="text-center p-2">
                  <img src="{{ p.imagen_url|default:'/static/img/placeholder.png' }}" class="img-fluid" style="max-height:140px; object-fit:contain;">
                </a>

                <div class="card-body d-flex flex-column">
                  <h6 class="product-name">{{ p.nombre|truncatechars:60 }}</h6>
                  <p class="text-muted small mb-1">{{ p.marca }}</p>
                  <p class="text-success fw-bold mb-1">${{ p.precio|floatformat:0 }}</p>
                  <p class="small text-muted">{{ p.supermercado.nombre }}</p>

                  <div class="mt-auto d-flex gap-2">
                    <a href="{{ p.producto_url }}" target="_blank" class="btn btn-outline-secondary btn-sm flex-grow-1">Ver</a>
                    <!-- class 'add-to-quote' usada en tu JS -->
                    <button class="btn btn-success btn-sm add-to-quote" data-product-id="{{ p.id }}">Agregar</button>
                  </div>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>

        {% if productos|length == 0 %}
          <p class="text-muted mt-3">No hay productos disponibles en esta categor√≠a.</p>
        {% endif %}
      </section>
    </div>
  </main>

  <footer class="footer text-center py-3 mt-4 bg-white">¬© 2025 Tucanasta. Todos los derechos reservados.</footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <!-- JS mini-cart / AJAX (misma l√≥gica que comparador) -->
  <script>
  // CSRF helper
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  const csrftoken = getCookie('csrftoken');

  const badgeEl = document.getElementById('cot-badge');
  const cartList = document.getElementById('cart-items-list');
  const cartTotalEl = document.getElementById('cart-total');
  const cartEmpty = document.getElementById('cart-empty');

  function formatMoney(n){ return '$' + (parseFloat(n || 0).toFixed(0)); }

  async function postForm(url, data){
    const resp = await fetch(url, {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrftoken,
        'X-Requested-With': 'XMLHttpRequest',
        'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'
      },
      body: new URLSearchParams(data),
      credentials: 'same-origin'
    });
    return resp.json();
  }

  function addOrUpdateCartItemFromResponse(data){
    if (!data || !data.ok) return;
    const id = String(data.item_id);
    let row = cartList.querySelector(`[data-item-id="${id}"]`);
    if (row){
      const qty = row.querySelector('.qty-in-cart');
      const subtotal = row.querySelector('.subtotal-in-cart');
      if (qty) qty.value = data.cantidad;
      if (subtotal) subtotal.innerText = formatMoney(data.subtotal);
    } else {
      const div = document.createElement('div');
      div.className = 'list-group-item d-flex align-items-center gap-3';
      div.dataset.itemId = id;
      div.innerHTML = `
        <img src="${data.producto_imagen || '/static/img/placeholder.png'}" alt="" style="width:56px;height:56px;object-fit:contain;border-radius:6px;border:1px solid #eee">
        <div class="flex-grow-1">
          <div class="fw-semibold">${data.producto}</div>
          <div class="small text-muted">${data.supermercado || ''} ¬∑ ${formatMoney(data.precio_unidad)}</div>
          <div class="mt-1 d-flex align-items-center gap-2">
            <button class="btn btn-sm btn-outline-secondary dec-item">‚àí</button>
            <input type="number" class="form-control form-control-sm qty-in-cart" value="${data.cantidad}" min="1" style="width:72px;">
            <button class="btn btn-sm btn-outline-secondary inc-item">+</button>
          </div>
        </div>
        <div class="text-end">
          <div class="fw-bold subtotal-in-cart">${formatMoney(data.subtotal)}</div>
          <button class="btn btn-sm btn-link text-danger remove-item-in-cart">Eliminar</button>
        </div>`;
      cartList.prepend(div);
      if (cartEmpty) cartEmpty.style.display = 'none';
    }

    if (badgeEl){
      if (data.count !== undefined) badgeEl.innerText = String(data.count);
      else badgeEl.innerText = (parseInt(badgeEl.innerText.replace(/\D/g,'')) || 0) + 1;
    }
    if (cartTotalEl && data.total !== undefined) cartTotalEl.innerText = formatMoney(data.total);
  }

  // Delegated events (inc/dec/remove)
  cartList?.addEventListener('click', async (ev) => {
    const target = ev.target;
    const row = target.closest('[data-item-id]');
    if (!row) return;
    const itemId = row.dataset.itemId;

    if (target.classList.contains('inc-item')){
      const input = row.querySelector('.qty-in-cart');
      const nueva = Math.max(1, parseInt(input.value || 0) + 1);
      await updateQty(itemId, nueva, row);
    } else if (target.classList.contains('dec-item')){
      const input = row.querySelector('.qty-in-cart');
      const nueva = Math.max(1, parseInt(input.value || 0) - 1);
      await updateQty(itemId, nueva, row);
    } else if (target.classList.contains('remove-item-in-cart')){
      if (!confirm('¬øEliminar este item de la cotizaci√≥n?')) return;
      await eliminarItem(itemId, row);
    }
  });

  cartList?.addEventListener('change', async (ev) => {
    const input = ev.target;
    if (input.classList.contains('qty-in-cart')){
      const row = input.closest('[data-item-id]');
      const itemId = row.dataset.itemId;
      const nueva = Math.max(1, parseInt(input.value || 1));
      await updateQty(itemId, nueva, row);
    }
  });

  async function updateQty(itemId, cantidad, row){
    try {
      const res = await postForm("{% url 'actualizar_item' %}", { item_id: itemId, cantidad });
      if (res.ok){
        if (res.total !== undefined) cartTotalEl.innerText = formatMoney(res.total);
        const qty = row.querySelector('.qty-in-cart'); if (qty) qty.value = cantidad;
        if (res.subtotal !== undefined){
          const subtotalEl = row.querySelector('.subtotal-in-cart'); if (subtotalEl) subtotalEl.innerText = formatMoney(res.subtotal);
        }
      } else alert(res.error || 'No se pudo actualizar la cantidad');
    } catch(e){ console.error(e); alert('Error red al actualizar cantidad'); }
  }

  async function eliminarItem(itemId, row){
    try {
      const res = await postForm("{% url 'eliminar_item' %}", { item_id: itemId });
      if (res.ok){
        row.remove();
        if (res.total !== undefined) cartTotalEl.innerText = formatMoney(res.total);
        if (badgeEl){
          if (res.count !== undefined) badgeEl.innerText = String(res.count);
          else badgeEl.innerText = Math.max(0, (parseInt(badgeEl.innerText.replace(/\D/g,'')) || 1) - 1);
        }
        if (!cartList.querySelector('[data-item-id]') && cartEmpty) cartEmpty.style.display = 'block';
      } else alert(res.error || 'No se pudo eliminar el item');
    } catch(e){ console.error(e); alert('Error red al eliminar item'); }
  }

  document.getElementById('save-cart-btn')?.addEventListener('click', async ()=> {
    try {
      const res = await postForm("{% url 'guardar_cotizacion' %}", {});
      if (res.ok) window.location.href = "{% url 'mis_cotizaciones' %}";
      else alert(res.error || 'No se pudo guardar la cotizaci√≥n');
    } catch(e){ console.error(e); alert('Error red al guardar la cotizaci√≥n'); }
  });

  // Handler "Agregar" on product cards
  document.querySelectorAll('.add-to-quote').forEach(b => {
    let inFlight = false;
    b.addEventListener('click', async () => {
      if (inFlight) return;
      inFlight = true;
      const id = b.dataset.productId; if (!id) { inFlight = false; return; }
      const prev = b.innerText; b.classList.add('disabled'); b.innerText = 'Enviando...';

      try {
        const resFetch = await fetch("{% url 'agregar_cotizacion' %}", {
          method: 'POST',
          headers: { 'X-CSRFToken': csrftoken, 'X-Requested-With': 'XMLHttpRequest', 'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8' },
          body: new URLSearchParams({ product_id: id, cantidad: 1 }),
          credentials: 'same-origin'
        });

        if (resFetch.redirected) { window.location.href = resFetch.url; return; }

        const ct = resFetch.headers.get('content-type') || '';
        if (ct.includes('application/json')) {
          const data = await resFetch.json();
          if (data.ok) { b.innerText = 'Agregado'; addOrUpdateCartItemFromResponse(data); }
          else { alert(data.error || 'No se pudo agregar'); b.innerText = prev; }
        } else {
          const txt = await resFetch.text();
          console.error('Respuesta inesperada:', txt); alert('Respuesta inesperada del servidor. Revisa la consola.'); b.innerText = prev;
        }
      } catch (err){
        console.error('Error al agregar:', err); alert('Error de red al agregar producto.'); b.innerText = prev;
      } finally {
        setTimeout(()=>{ b.classList.remove('disabled'); inFlight = false; }, 700);
      }
    });
  });
  </script>
</body>
</html>
