{% load static %}
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Iniciar sesión</title>

  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Fuentes + Bootstrap + Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <link rel="stylesheet" href="{% static 'css/login.css' %}?v={{ timestamp }}">
</head>
<body>
  <div class="login-card mx-auto">
    <h1>Iniciar sesión</h1>

    <!-- Mensajes tipo Django messages (map a clases bootstrap) -->
    {% if messages %}
      {% for message in messages %}
        {% if 'error' in message.tags %}
          <div class="alert alert-danger" role="alert">{{ message }}</div>
        {% elif 'warning' in message.tags %}
          <div class="alert alert-warning" role="alert">{{ message }}</div>
        {% elif 'success' in message.tags %}
          <div class="alert alert-success" role="alert">{{ message }}</div>
        {% else %}
          <div class="alert alert-info" role="alert">{{ message }}</div>
        {% endif %}
      {% endfor %}
    {% endif %}

    <!-- Si usas LoginView con form, muestra errores no_field_errors -->
    {% if form and form.non_field_errors %}
      <div class="alert alert-danger" role="alert">
        {% for err in form.non_field_errors %}
          {{ err }}{% if not forloop.last %}<br>{% endif %}
        {% endfor %}
      </div>
    {% endif %}

    <form method="post" action="{% url 'login' %}">
      {% csrf_token %}

      <!-- Usuario (conserva el valor enviado tras POST) -->
      <div class="mb-3">
        <label for="id_username" class="form-label">Usuario</label>
        <input
          type="text"
          name="username"
          id="id_username"
          class="form-control"
          placeholder="Tu nombre de usuario"
          required
          autofocus
          value="{{ request.POST.username|default:'' }}"
        >
      </div>

      <!-- Contraseña con icono ojo -->
      <div class="mb-3">
        <label for="id_password" class="form-label">Contraseña</label>
        <div class="input-group input-with-icon">
          <input
            type="password"
            name="password"
            id="id_password"
            class="form-control"
            placeholder="••••••••"
            required
            aria-describedby="togglePasswordBtn"
          >
          <span class="input-group-text toggle-password" id="togglePasswordBtn" role="button" aria-label="Mostrar contraseña">
            <i class="bi bi-eye-slash" id="togglePasswordIcon" style="font-size:1.05rem; color:#6b7280;"></i>
          </span>
        </div>
      </div>

      <div class="d-grid mt-3">
        <button type="submit" class="btn btn-primary custom">Entrar</button>
      </div>
    </form>

    <div class="text-center small-links mt-3">
      <p class="mb-1">¿No tienes cuenta? <a href="{% url 'signup' %}">Crear cuenta</a></p>
      <p class="mb-0"><a href="{% url 'index' %}">← Volver</a></p>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Toggle password JS -->
  <script>
    (function () {
      const toggleBtn = document.getElementById('togglePasswordBtn');
      if (!toggleBtn) return;
      const pwd = document.getElementById('id_password');
      const icon = document.getElementById('togglePasswordIcon');

      toggleBtn.addEventListener('click', (e) => {
        e.preventDefault();
        if (pwd.type === 'password') {
          pwd.type = 'text';
          icon.classList.remove('bi-eye-slash');
          icon.classList.add('bi-eye');
          toggleBtn.setAttribute('aria-label', 'Ocultar contraseña');
        } else {
          pwd.type = 'password';
          icon.classList.remove('bi-eye');
          icon.classList.add('bi-eye-slash');
          toggleBtn.setAttribute('aria-label', 'Mostrar contraseña');
        }
        pwd.focus({preventScroll:true});
      });

      toggleBtn.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault(); toggleBtn.click();
        }
      });
    })();
  </script>
</body>
</html>
