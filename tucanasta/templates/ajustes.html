{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Ajustes ‚Ä¢ Tucanasta</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Tu CSS principal -->
  <link rel="stylesheet" href="{% static 'css/main.css' %}">
  <style>
    .card-settings { max-width: 900px; margin: 24px auto; }
    .avatar-placeholder { width:72px; height:72px; border-radius:12px; background:#f1f3f5; display:inline-flex; align-items:center; justify-content:center; font-weight:600; color:#6c757d; }
    /* ajusta offcanvas para que no tape botones fijos en mobile */
    .offcanvas { --bs-offcanvas-width: 360px; }
  </style>
</head>
<body class="bg-light">

  <!-- NAVBAR -->
  <nav class="navbar navbar-dark bg-dark fixed-top shadow-sm">
    <div class="container-fluid">
      <a class="navbar-brand d-flex align-items-center" href="{% url 'comparador' %}">
        <img src="{% static 'img/logotucan.png' %}" alt="Tucanasta" class="logo-img me-2" style="height:28px">
        <span class="brand-text">Tucanasta</span>
      </a>

      <div class="d-flex align-items-center gap-2">
        <!-- bot√≥n mini-cart id√©ntico a otras p√°ginas -->
        <button class="btn btn-outline-light position-relative" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasCart" aria-controls="offcanvasCart" id="cart-toggle">
          üß∫
          <span id="cot-badge" class="badge bg-danger ms-1">
            {% if cot_items %}{{ cot_items|length }}{% else %}0{% endif %}
          </span>
        </button>

        {% if user.is_authenticated %}
          <div class="dropdown">
            <button class="btn btn-outline-light dropdown-toggle" id="userMenu" data-bs-toggle="dropdown" aria-expanded="false">üë§ {{ user.username }}</button>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userMenu">
              <li><a class="dropdown-item" href="{% url 'ver_cotizacion' %}">Cotizaciones</a></li>
              <li><a class="dropdown-item" href="{% url 'ajustes' %}">Ajustes</a></li>
              <li><hr class="dropdown-divider"></li>
              <li>
                <form method="post" action="{% url 'logout' %}" class="m-0">
                  {% csrf_token %}
                  <button type="submit" class="dropdown-item">Cerrar sesi√≥n</button>
                </form>
              </li>
            </ul>
          </div>
        {% else %}
          <a href="{% url 'login' %}" class="btn btn-outline-light">Iniciar sesi√≥n</a>
        {% endif %}
      </div>
    </div>
  </nav>

  <!-- OFFCANVAS MINI-CART (MISMO ESTRUCTURA QUE EN OTRAS PLANTILLAS) -->
  <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasCart" aria-labelledby="offcanvasCartLabel">
    <div class="offcanvas-header">
      <h5 id="offcanvasCartLabel">Mi cotizaci√≥n</h5>
      <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Cerrar"></button>
    </div>

    <div class="offcanvas-body d-flex flex-column">
      <div id="cart-items-list" class="list-group mb-3">
        {% if cot_items %}
          {% for it in cot_items %}
            <div class="list-group-item d-flex align-items-center gap-3" data-item-id="{{ it.pk }}">
              <img src="{{ it.producto.imagen_url|default:'/static/img/placeholder.png' }}" alt=""
                   style="width:56px;height:56px;object-fit:contain;border-radius:6px;border:1px solid #eee">
              <div class="flex-grow-1">
                <div class="fw-semibold">{{ it.producto.nombre|truncatechars:50 }}</div>
                <div class="small text-muted">{{ it.producto.supermercado.nombre }} ¬∑ ${{ it.precio_unidad|floatformat:0 }}</div>
                <div class="mt-1 d-flex align-items-center gap-2">
                  <button class="btn btn-sm btn-outline-secondary dec-item">‚àí</button>
                  <input type="number" class="form-control form-control-sm qty-in-cart" value="{{ it.cantidad }}" min="1" style="width:72px;">
                  <button class="btn btn-sm btn-outline-secondary inc-item">+</button>
                </div>
              </div>
              <div class="text-end">
                <div class="fw-bold subtotal-in-cart">${{ it.subtotal|floatformat:0 }}</div>
                <button class="btn btn-sm btn-link text-danger remove-item-in-cart">Eliminar</button>
              </div>
            </div>
          {% endfor %}
        {% else %}
          <div class="text-center text-muted py-4" id="cart-empty">No hay productos en la cotizaci√≥n.</div>
        {% endif %}
      </div>

      <div class="mt-auto">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="text-muted">Total estimado</div>
          <div class="fs-5 fw-bold text-success" id="cart-total">${% if cotizacion %}{{ cotizacion.total|floatformat:0 }}{% else %}0{% endif %}</div>
        </div>
        <div class="d-grid gap-2">
          <a href="{% url 'ver_cotizacion' %}" class="btn btn-primary">Ver cotizaci√≥n completa</a>
          <button id="save-cart-btn" class="btn btn-outline-success">Guardar cotizaci√≥n</button>
        </div>
      </div>
    </div>
  </div>

  <!-- MAIN AJUSTES -->
  <main class="container" style="padding-top:96px; padding-bottom:48px;">
    <div class="card card-settings shadow-sm">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between mb-3">
          <h4 class="mb-0">Ajustes de tu cuenta</h4>
          <small class="text-muted">Gestiona tu perfil y contrase√±a</small>
        </div>

        {% if messages %}
          {% for message in messages %}
            <div class="alert alert-{{ message.tags|default:'info' }} alert-dismissible fade show" role="alert">
              {{ message }}
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
            </div>
          {% endfor %}
        {% endif %}

        <div class="row g-4">
          <!-- PERFIL -->
          <div class="col-lg-7">
            <div class="card border-0">
              <div class="card-body">
                <h5 class="mb-3">Perfil</h5>
                <form method="post" novalidate>
                  {% csrf_token %}
                  <input type="hidden" name="profile_submit" value="1">

                  <div class="mb-3">
                    <label class="form-label">Nombre de usuario</label>
                    {{ profile_form.username }}
                    {% if profile_form.username.errors %}
                      <div class="invalid-feedback d-block">{{ profile_form.username.errors|join:", " }}</div>
                    {% endif %}
                  </div>

                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label class="form-label">Nombre</label>
                      {{ profile_form.first_name }}
                      {% if profile_form.first_name.errors %}
                        <div class="invalid-feedback d-block">{{ profile_form.first_name.errors|join:", " }}</div>
                      {% endif %}
                    </div>
                    <div class="col-md-6 mb-3">
                      <label class="form-label">Apellido</label>
                      {{ profile_form.last_name }}
                      {% if profile_form.last_name.errors %}
                        <div class="invalid-feedback d-block">{{ profile_form.last_name.errors|join:", " }}</div>
                      {% endif %}
                    </div>
                  </div>

                  <div class="mb-3">
                    <label class="form-label">Email</label>
                    {{ profile_form.email }}
                    {% if profile_form.email.errors %}
                      <div class="invalid-feedback d-block">{{ profile_form.email.errors|join:", " }}</div>
                    {% endif %}
                  </div>

                  <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-primary">Guardar cambios</button>
                    <a href="{% url 'comparador' %}" class="btn btn-outline-secondary">Cancelar</a>
                  </div>
                </form>
              </div>
            </div>
          </div>

          <!-- CAMBIO DE CONTRASE√ëA -->
          <div class="col-lg-5">
            <div class="card border-0">
              <div class="card-body">
                <h5 class="mb-3">Cambiar contrase√±a</h5>
                <form method="post" novalidate>
                  {% csrf_token %}
                  <input type="hidden" name="password_submit" value="1">

                  <div class="mb-2">
                    <label class="form-label small">Contrase√±a actual</label>
                    {{ password_form.old_password }}
                    {% if password_form.old_password.errors %}
                      <div class="invalid-feedback d-block">{{ password_form.old_password.errors|join:", " }}</div>
                    {% endif %}
                  </div>

                  <div class="mb-2">
                    <label class="form-label small">Nueva contrase√±a</label>
                    {{ password_form.new_password1 }}
                    {% if password_form.new_password1.errors %}
                      <div class="invalid-feedback d-block">{{ password_form.new_password1.errors|join:", " }}</div>
                    {% endif %}
                  </div>

                  <div class="mb-3">
                    <label class="form-label small">Confirmar nueva contrase√±a</label>
                    {{ password_form.new_password2 }}
                    {% if password_form.new_password2.errors %}
                      <div class="invalid-feedback d-block">{{ password_form.new_password2.errors|join:", " }}</div>
                    {% endif %}
                  </div>

                  <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-success">Cambiar contrase√±a</button>
                    <button type="button" id="toggle-passwords" class="btn btn-outline-secondary">Mostrar / ocultar</button>
                  </div>
                </form>
              </div>
            </div>

            <hr>

            <div class="mt-3 text-muted small">
              <p class="mb-1"><strong>Consejo:</strong> usa una contrase√±a segura y memor√≠zala.</p>
              <p class="mb-0">Si olvidas tu contrase√±a usa la opci√≥n de recuperaci√≥n desde login.</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <footer class="text-center py-4 bg-white mt-4">
    ¬© 2025 Tucanasta. Todos los derechos reservados.
  </footer>

  <!-- Bootstrap bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <!-- === JS mini-cart (mismo script que en las otras p√°ginas) === -->
  <script>
  // CSRF helper
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  const csrftoken = getCookie('csrftoken');

  // DOM refs
  const badgeEl = document.getElementById('cot-badge');
  const cartList = document.getElementById('cart-items-list');
  const cartTotalEl = document.getElementById('cart-total');
  const cartEmpty = document.getElementById('cart-empty');

  function formatMoney(n){ return '$' + (parseFloat(n || 0).toFixed(0)); }

  async function postForm(url, data){
    const resp = await fetch(url, {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrftoken,
        'X-Requested-With': 'XMLHttpRequest',
        'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'
      },
      body: new URLSearchParams(data),
      credentials: 'same-origin'
    });
    return resp.json();
  }

  function addOrUpdateCartItemFromResponse(data){
    if (!data || !data.ok) return;
    const id = String(data.item_id);
    let row = cartList.querySelector(`[data-item-id="${id}"]`);
    if (row){
      const qty = row.querySelector('.qty-in-cart');
      const subtotal = row.querySelector('.subtotal-in-cart');
      if (qty) qty.value = data.cantidad;
      if (subtotal) subtotal.innerText = formatMoney(data.subtotal);
    } else {
      const div = document.createElement('div');
      div.className = 'list-group-item d-flex align-items-center gap-3';
      div.dataset.itemId = id;
      div.innerHTML = `
        <img src="${data.producto_imagen || '/static/img/placeholder.png'}" alt="" style="width:56px;height:56px;object-fit:contain;border-radius:6px;border:1px solid #eee">
        <div class="flex-grow-1">
          <div class="fw-semibold">${data.producto}</div>
          <div class="small text-muted">${data.supermercado || ''} ¬∑ ${formatMoney(data.precio_unidad)}</div>
          <div class="mt-1 d-flex align-items-center gap-2">
            <button class="btn btn-sm btn-outline-secondary dec-item">‚àí</button>
            <input type="number" class="form-control form-control-sm qty-in-cart" value="${data.cantidad}" min="1" style="width:72px;">
            <button class="btn btn-sm btn-outline-secondary inc-item">+</button>
          </div>
        </div>
        <div class="text-end">
          <div class="fw-bold subtotal-in-cart">${formatMoney(data.subtotal)}</div>
          <button class="btn btn-sm btn-link text-danger remove-item-in-cart">Eliminar</button>
        </div>`;
      cartList.prepend(div);
      if (cartEmpty) cartEmpty.style.display = 'none';
    }

    // badge y total
    if (badgeEl){
      if (data.count !== undefined) badgeEl.innerText = String(data.count);
      else badgeEl.innerText = (parseInt(badgeEl.innerText.replace(/\D/g,'')) || 0) + 1;
    }
    if (cartTotalEl && data.total !== undefined) cartTotalEl.innerText = formatMoney(data.total);
  }

  // Delegated events (inc/dec/remove)
  cartList?.addEventListener('click', async (ev) => {
    const target = ev.target;
    const row = target.closest('[data-item-id]');
    if (!row) return;
    const itemId = row.dataset.itemId;

    if (target.classList.contains('inc-item')){
      const input = row.querySelector('.qty-in-cart');
      const nueva = Math.max(1, parseInt(input.value || 0) + 1);
      await updateQty(itemId, nueva, row);
    } else if (target.classList.contains('dec-item')){
      const input = row.querySelector('.qty-in-cart');
      const nueva = Math.max(1, parseInt(input.value || 0) - 1);
      await updateQty(itemId, nueva, row);
    } else if (target.classList.contains('remove-item-in-cart')){
      if (!confirm('¬øEliminar este item de la cotizaci√≥n?')) return;
      await eliminarItem(itemId, row);
    }
  });

  // change handler for qty inputs
  cartList?.addEventListener('change', async (ev) => {
    const input = ev.target;
    if (input.classList.contains('qty-in-cart')){
      const row = input.closest('[data-item-id]');
      const itemId = row.dataset.itemId;
      const nueva = Math.max(1, parseInt(input.value || 1));
      await updateQty(itemId, nueva, row);
    }
  });

  async function updateQty(itemId, cantidad, row){
    try {
      const res = await postForm("{% url 'actualizar_item' %}", { item_id: itemId, cantidad });
      if (res.ok){
        if (res.total !== undefined) cartTotalEl.innerText = formatMoney(res.total);
        const qty = row.querySelector('.qty-in-cart'); if (qty) qty.value = cantidad;
        if (res.subtotal !== undefined){
          const subtotalEl = row.querySelector('.subtotal-in-cart'); if (subtotalEl) subtotalEl.innerText = formatMoney(res.subtotal);
        }
      } else {
        alert(res.error || 'No se pudo actualizar la cantidad');
      }
    } catch(e){ console.error(e); alert('Error red al actualizar cantidad'); }
  }

  async function eliminarItem(itemId, row){
    try {
      const res = await postForm("{% url 'eliminar_item' %}", { item_id: itemId });
      if (res.ok){
        row.remove();
        if (res.total !== undefined) cartTotalEl.innerText = formatMoney(res.total);
        if (badgeEl){
          if (res.count !== undefined) badgeEl.innerText = String(res.count);
          else badgeEl.innerText = Math.max(0, (parseInt(badgeEl.innerText.replace(/\D/g,'')) || 1) - 1);
        }
        if (!cartList.querySelector('[data-item-id]') && cartEmpty) cartEmpty.style.display = 'block';
      } else {
        alert(res.error || 'No se pudo eliminar el item');
      }
    } catch(e){ console.error(e); alert('Error red al eliminar item'); }
  }

  // Guardar cotizaci√≥n
  document.getElementById('save-cart-btn')?.addEventListener('click', async ()=> {
    try {
      const res = await postForm("{% url 'guardar_cotizacion' %}", {});
      if (res.ok) window.location.href = "{% url 'mis_cotizaciones' %}";
      else alert(res.error || 'No se pudo guardar la cotizaci√≥n');
    } catch(e){ console.error(e); alert('Error red al guardar la cotizaci√≥n'); }
  });

  // (Opcional) Handler global "Agregar" por si hay botones en la p√°gina
  document.querySelectorAll('.add-to-quote, .add-btn').forEach(b => {
    let inFlight = false;
    b.addEventListener('click', async () => {
      if (inFlight) return;
      inFlight = true;
      const id = b.dataset.productId; if (!id) { inFlight = false; return; }
      const prev = b.innerText; b.classList.add('disabled'); b.innerText = 'Enviando...';
      try {
        const resFetch = await fetch("{% url 'agregar_cotizacion' %}", {
          method: 'POST',
          headers: { 'X-CSRFToken': csrftoken, 'X-Requested-With': 'XMLHttpRequest', 'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8' },
          body: new URLSearchParams({ product_id: id, cantidad: 1 }),
          credentials: 'same-origin'
        });
        if (resFetch.redirected) { window.location.href = resFetch.url; return; }
        const ct = resFetch.headers.get('content-type') || '';
        if (ct.includes('application/json')) {
          const data = await resFetch.json();
          if (data.ok) { b.innerText = 'Agregado'; addOrUpdateCartItemFromResponse(data); }
          else { alert(data.error || 'No se pudo agregar'); b.innerText = prev; }
        } else {
          const txt = await resFetch.text();
          console.error('Respuesta inesperada:', txt); alert('Respuesta inesperada del servidor. Revisa la consola.'); b.innerText = prev;
        }
      } catch (err){
        console.error('Error al agregar:', err); alert('Error de red al agregar producto.'); b.innerText = prev;
      } finally {
        setTimeout(()=>{ b.classList.remove('disabled'); inFlight = false; }, 700);
      }
    });
  });

  // Mostrar / ocultar passwords
  document.getElementById('toggle-passwords')?.addEventListener('click', function(){
    document.querySelectorAll('input[type="password"]').forEach(inp=>{
      inp.type = inp.type === 'password' ? 'text' : 'password';
    });
  });
  </script>
</body>
</html>
